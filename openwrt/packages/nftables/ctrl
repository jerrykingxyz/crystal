#!/bin/sh

set -e

CUR_DIR=$(dirname "$(readlink -f -- "$0")")
OPENWRT_DIR=$(dirname $(dirname $CUR_DIR))
TEMP_DIR="$OPENWRT_DIR/temp_conf"
source $OPENWRT_DIR/utils

ACTION=$1
CFG_FILE="$CUR_DIR/config"
TEMPLATE_FILE="$CUR_DIR/template.cfg"
OUTPUT_CFG_FILE="$TEMP_DIR/nft.cfg"

#if [ "$ACTION" = "setup" ]; then
#    echo "setup"
#fi

if [ "$ACTION" = "start" ]; then
    if [[ $(ip route list) != *"default"* ]]; then
        ip route add local default dev lo table 100
    fi
    if [[ $(ip rule list) != *"fwmark"* ]]; then
        ip rule add fwmark 1 table 100
    fi
    render_config $TEMPLATE_FILE $CFG_FILE > $OUTPUT_CFG_FILE
fi

if [ "$ACTION" = "stop" ]; then
    if [[ $(ip route list) == *"default"* ]]; then
        ip route del local default dev lo table 100
    fi
    if [[ $(ip rule list) == *"fwmark"* ]]; then
        ip rule del fwmark 1 table 100
    fi
    echo "stop"
fi
